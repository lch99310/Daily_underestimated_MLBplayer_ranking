<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MLB Underestimated Player Analyzer</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;500;600;700&family=Source+Sans+3:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deepest: #050b15;
  --bg-deep: #0a1628;
  --bg-card: #0f1f38;
  --bg-card-hover: #142a4a;
  --bg-surface: #1a2d4d;
  --border-subtle: rgba(255,255,255,0.06);
  --border-mid: rgba(255,255,255,0.1);
  --text-primary: #e8ecf2;
  --text-secondary: #8a9bb8;
  --text-muted: #556a8a;
  --accent-red: #e8243c;
  --accent-red-glow: rgba(232,36,60,0.3);
  --accent-gold: #f0c040;
  --accent-gold-dim: rgba(240,192,64,0.2);
  --accent-blue: #3b82f6;
  --accent-blue-dim: rgba(59,130,246,0.15);
  --accent-green: #22c55e;
  --accent-green-dim: rgba(34,197,94,0.15);
  --negative-strong: #ef4444;
  --negative-mid: #f97316;
  --negative-light: #fb923c;
  --positive-strong: #22c55e;
  --positive-mid: #4ade80;
  --positive-light: #86efac;
  --font-display: 'Oswald', sans-serif;
  --font-body: 'Source Sans 3', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --shadow-card: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-glow-red: 0 0 30px rgba(232,36,60,0.15);
  --transition-fast: 150ms ease;
  --transition-mid: 300ms ease;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth;font-size:15px}
body{font-family:var(--font-body);background:var(--bg-deepest);color:var(--text-primary);line-height:1.5;overflow-x:hidden;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg-deep)}
::-webkit-scrollbar-thumb{background:var(--bg-surface);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}

/* NAV */
.topnav{position:fixed;top:0;left:0;right:0;z-index:1000;background:rgba(5,11,21,0.88);backdrop-filter:blur(16px);border-bottom:1px solid var(--border-subtle);height:48px;display:flex;align-items:center;padding:0 24px}
.topnav-brand{font-family:var(--font-display);font-weight:700;font-size:1.1rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-primary);margin-right:32px;white-space:nowrap}
.topnav-brand span{color:var(--accent-red)}
.topnav-links{display:flex;gap:4px;overflow-x:auto}
.topnav-links a{font-family:var(--font-body);font-size:.8rem;font-weight:600;color:var(--text-secondary);text-decoration:none;padding:6px 14px;border-radius:var(--radius-sm);transition:var(--transition-fast);white-space:nowrap;letter-spacing:.3px;text-transform:uppercase}
.topnav-links a:hover,.topnav-links a.active{color:var(--text-primary);background:var(--bg-card)}

/* LOADING */
.loading-screen{position:fixed;inset:0;background:var(--bg-deepest);z-index:2000;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .5s}
.loading-screen.hidden{opacity:0;pointer-events:none}
.loading-spinner{width:40px;height:40px;border:3px solid var(--bg-surface);border-top-color:var(--accent-red);border-radius:50%;animation:spin .8s linear infinite}
.loading-text{font-family:var(--font-display);font-size:1.1rem;color:var(--text-secondary);margin-top:16px;letter-spacing:1px;text-transform:uppercase}
@keyframes spin{to{transform:rotate(360deg)}}

/* HERO */
.hero{padding:96px 24px 48px;background:linear-gradient(180deg,var(--bg-deep) 0%,var(--bg-deepest) 100%);position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;top:0;left:50%;transform:translateX(-50%);width:800px;height:800px;background:radial-gradient(ellipse,rgba(232,36,60,0.06) 0%,transparent 70%);pointer-events:none}
.hero-inner{max-width:1320px;margin:0 auto;position:relative}
.hero-eyebrow{font-family:var(--font-mono);font-size:.7rem;font-weight:500;color:var(--accent-red);letter-spacing:3px;text-transform:uppercase;margin-bottom:12px;opacity:0;animation:fadeUp .6s .2s forwards;display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.hero-date{font-family:var(--font-mono);font-size:.68rem;font-weight:500;color:var(--accent-gold);background:var(--accent-gold-dim);padding:3px 10px;border-radius:var(--radius-sm);letter-spacing:1px;text-transform:uppercase;white-space:nowrap}
.hero-title{font-family:var(--font-display);font-size:clamp(2.4rem,5.5vw,4.2rem);font-weight:700;line-height:1.05;letter-spacing:-0.5px;text-transform:uppercase;margin-bottom:16px;opacity:0;animation:fadeUp .6s .35s forwards}
.hero-title em{font-style:normal;color:var(--accent-gold)}
.hero-sub{font-size:1.05rem;color:var(--text-secondary);max-width:680px;line-height:1.65;margin-bottom:36px;opacity:0;animation:fadeUp .6s .5s forwards}
.hero-sub code{font-family:var(--font-mono);font-size:.85rem;background:var(--accent-blue-dim);color:var(--accent-blue);padding:2px 7px;border-radius:3px}
.kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;opacity:0;animation:fadeUp .6s .65s forwards}
.kpi{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-md);padding:20px 22px;position:relative;overflow:hidden}
.kpi::after{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.kpi:nth-child(1)::after{background:var(--accent-red)}
.kpi:nth-child(2)::after{background:var(--accent-gold)}
.kpi:nth-child(3)::after{background:var(--accent-blue)}
.kpi:nth-child(4)::after{background:var(--accent-green)}
.kpi-label{font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:6px}
.kpi-value{font-family:var(--font-display);font-size:2rem;font-weight:600;line-height:1.1}
.kpi-detail{font-size:.78rem;color:var(--text-secondary);margin-top:4px}

/* SECTIONS */
.section{padding:56px 24px;max-width:1320px;margin:0 auto}
.section-header{margin-bottom:28px;opacity:0;transform:translateY(16px);transition:opacity .5s,transform .5s}
.section-header.visible{opacity:1;transform:translateY(0)}
.section-tag{font-family:var(--font-mono);font-size:.65rem;font-weight:500;color:var(--accent-red);letter-spacing:3px;text-transform:uppercase;margin-bottom:6px}
.section-title{font-family:var(--font-display);font-size:1.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px}

/* TABLE */
.table-controls{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:16px;align-items:center}
.table-controls input,.table-controls select{font-family:var(--font-body);font-size:.82rem;background:var(--bg-card);border:1px solid var(--border-mid);color:var(--text-primary);padding:8px 14px;border-radius:var(--radius-sm);outline:none;transition:var(--transition-fast)}
.table-controls input:focus,.table-controls select:focus{border-color:var(--accent-blue);box-shadow:0 0 0 2px var(--accent-blue-dim)}
.table-controls input{width:240px}
.table-controls select{min-width:120px;cursor:pointer}

/* PA Window Toggle */
.pa-toggle{display:flex;gap:2px;background:var(--bg-card);border:1px solid var(--border-mid);border-radius:var(--radius-sm);padding:2px;margin-left:auto}
.pa-toggle button{font-family:var(--font-mono);font-size:.72rem;font-weight:600;padding:6px 14px;border:none;border-radius:3px;background:transparent;color:var(--text-muted);cursor:pointer;transition:var(--transition-fast);white-space:nowrap}
.pa-toggle button:hover{color:var(--text-secondary)}
.pa-toggle button.active{background:var(--accent-red);color:#fff}
.pa-toggle button.disabled{opacity:0.3;cursor:not-allowed}
.pa-toggle button.disabled:hover{color:var(--text-muted)}

.table-wrap{overflow-x:auto;border-radius:var(--radius-md);border:1px solid var(--border-subtle);background:var(--bg-card)}
table{width:100%;border-collapse:collapse;font-size:.82rem}
thead th{font-family:var(--font-body);font-weight:600;font-size:.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);padding:12px 14px;text-align:left;border-bottom:1px solid var(--border-mid);position:sticky;top:0;background:var(--bg-card);cursor:pointer;white-space:nowrap;user-select:none;transition:var(--transition-fast)}
thead th:hover{color:var(--text-primary)}
thead th.sorted-asc::after{content:' \u25B2';font-size:.6rem}
thead th.sorted-desc::after{content:' \u25BC';font-size:.6rem}
tbody tr{border-bottom:1px solid var(--border-subtle);cursor:pointer;transition:var(--transition-fast)}
tbody tr:hover{background:var(--bg-card-hover)}
tbody tr.selected{background:var(--accent-blue-dim);border-left:3px solid var(--accent-blue)}
td{padding:10px 14px;white-space:nowrap;font-variant-numeric:tabular-nums}
td.player-name{font-weight:600;color:var(--text-primary)}
td.team-cell{font-family:var(--font-mono);font-size:.75rem;font-weight:500}
td.diff-cell{font-family:var(--font-mono);font-weight:600;border-radius:3px;text-align:center}
td.stat-cell{font-family:var(--font-mono);font-size:.8rem;color:var(--text-secondary)}
.rank-cell{font-family:var(--font-mono);font-weight:600;color:var(--text-muted);font-size:.75rem;width:36px;text-align:center}
.table-info{font-size:.75rem;color:var(--text-muted);margin-top:8px;font-family:var(--font-mono)}

/* PLAYER DETAIL */
#player-detail{display:block}
.detail-grid{display:grid;grid-template-columns:340px 1fr;gap:20px}
@media(max-width:900px){.detail-grid{grid-template-columns:1fr}}
.detail-card{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:28px;position:relative;overflow:hidden}
.detail-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent-red),var(--accent-gold))}
.detail-name{font-family:var(--font-display);font-size:1.6rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.detail-meta{font-size:.82rem;color:var(--text-secondary);margin-bottom:20px}
.detail-meta span{margin-right:12px}
.detail-meta .team-badge{font-family:var(--font-mono);font-weight:600;background:var(--bg-surface);padding:2px 8px;border-radius:3px;font-size:.72rem}
.detail-savant-link{font-size:.72rem;color:var(--accent-blue);text-decoration:none;display:inline-block;margin-top:4px}
.detail-savant-link:hover{text-decoration:underline}
.woba-compare{display:flex;gap:16px;margin-bottom:20px}
.woba-box{flex:1;text-align:center;padding:16px 12px;border-radius:var(--radius-md);background:var(--bg-surface)}
.woba-box-label{font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:6px}
.woba-box-value{font-family:var(--font-display);font-size:2rem;font-weight:600}
.diff-display{text-align:center;padding:16px;border-radius:var(--radius-md);margin-bottom:20px}
.diff-display-value{font-family:var(--font-display);font-size:2.4rem;font-weight:700}
.diff-display-label{font-size:.72rem;color:var(--text-secondary);margin-top:4px;line-height:1.4}
.statcast-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.statcast-item{background:var(--bg-surface);padding:12px;border-radius:var(--radius-sm);text-align:center}
.statcast-item-val{font-family:var(--font-display);font-size:1.3rem;font-weight:600}
.statcast-item-label{font-size:.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-top:2px}
.detail-chart-wrap{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:20px;min-height:360px}
.detail-actions{display:flex;gap:8px;margin-top:16px}
.btn{font-family:var(--font-body);font-size:.78rem;font-weight:600;padding:8px 18px;border-radius:var(--radius-sm);border:1px solid var(--border-mid);background:var(--bg-surface);color:var(--text-secondary);cursor:pointer;transition:var(--transition-fast);text-transform:uppercase;letter-spacing:.5px}
.btn:hover{background:var(--bg-card-hover);color:var(--text-primary)}
.btn-primary{background:var(--accent-red);border-color:var(--accent-red);color:#fff}
.btn-primary:hover{background:#cc1e34;box-shadow:var(--shadow-glow-red)}

/* Window pills in detail */
.detail-window-toggle{display:flex;gap:4px;margin:12px 0}
.detail-window-toggle button{font-family:var(--font-mono);font-size:.68rem;font-weight:600;padding:4px 12px;border:1px solid var(--border-mid);border-radius:3px;background:transparent;color:var(--text-muted);cursor:pointer;transition:var(--transition-fast)}
.detail-window-toggle button:hover{color:var(--text-secondary)}
.detail-window-toggle button.active{background:var(--accent-blue-dim);border-color:var(--accent-blue);color:var(--accent-blue)}
.detail-window-toggle button.disabled{opacity:0.3;cursor:not-allowed}
.detail-window-toggle button.disabled:hover{color:var(--text-muted)}

/* CHARTS */
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px}
@media(max-width:960px){.charts-grid{grid-template-columns:1fr}}
.chart-card{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:20px;overflow:hidden}
.chart-card-title{font-family:var(--font-display);font-size:1rem;font-weight:500;text-transform:uppercase;letter-spacing:.5px;color:var(--text-secondary);margin-bottom:4px}
.chart-card-sub{font-size:.72rem;color:var(--text-muted);margin-bottom:12px}
.chart-container{height:380px;width:100%}
.chart-container-tall{height:420px}
.chart-full{grid-column:1/-1}

/* METHODOLOGY */
.method-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}
.method-card{background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:var(--radius-lg);padding:28px;position:relative}
.method-card::before{content:'';position:absolute;top:20px;left:0;width:3px;height:40px;border-radius:0 2px 2px 0}
.method-card:nth-child(1)::before{background:var(--accent-blue)}
.method-card:nth-child(2)::before{background:var(--accent-gold)}
.method-card:nth-child(3)::before{background:var(--accent-red)}
.method-card h3{font-family:var(--font-display);font-size:1.15rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.method-card h3 code{font-family:var(--font-mono);font-size:.85rem;background:var(--accent-blue-dim);color:var(--accent-blue);padding:2px 7px;border-radius:3px;text-transform:none;letter-spacing:0}
.method-card p{font-size:.88rem;color:var(--text-secondary);line-height:1.65}
.method-card .formula{font-family:var(--font-mono);font-size:.78rem;background:var(--bg-surface);padding:10px 14px;border-radius:var(--radius-sm);margin-top:12px;color:var(--accent-gold);border-left:2px solid var(--accent-gold)}

/* FOOTER */
.footer{border-top:1px solid var(--border-subtle);padding:36px 24px;text-align:center;margin-top:40px}
.footer p{font-size:.78rem;color:var(--text-muted);line-height:1.7;max-width:680px;margin:0 auto}
.footer a{color:var(--accent-blue);text-decoration:none}
.footer a:hover{text-decoration:underline}

/* ANIMATIONS */
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.fade-section{opacity:0;transform:translateY(20px);transition:opacity .55s ease,transform .55s ease}
.fade-section.visible{opacity:1;transform:translateY(0)}

/* RESPONSIVE */
@media(max-width:768px){
  .topnav{padding:0 12px}
  .topnav-brand{font-size:.9rem;margin-right:16px}
  .hero{padding:72px 16px 36px}
  .section{padding:40px 16px}
  .kpi-row{grid-template-columns:1fr 1fr}
  .table-controls input{width:100%}
  .table-controls{flex-direction:column}
  .pa-toggle{margin-left:0}
  .detail-grid{grid-template-columns:1fr}
  .charts-grid{grid-template-columns:1fr}
  .chart-container{height:300px}
}
@media(max-width:480px){
  .kpi-row{grid-template-columns:1fr}
  .woba-compare{flex-direction:column}
}
</style>
</head>
<body>

<div class="loading-screen" id="loading">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading Statcast Data</div>
</div>

<nav class="topnav">
  <div class="topnav-brand"><span>MLB</span> ANALYZER</div>
  <div class="topnav-links">
    <a href="#rankings" class="active">Rankings</a>
    <a href="#player-detail">Player</a>
    <a href="#analytics">Analytics</a>
    <a href="#methodology">Methodology</a>
  </div>
</nav>

<section class="hero">
  <div class="hero-inner">
    <div class="hero-eyebrow" id="hero-eyebrow">Statcast-Powered Analytics<span class="hero-date" id="hero-date"></span></div>
    <h1 class="hero-title">Underestimated Player<br><em>Analyzer</em></h1>
    <p class="hero-sub">Identifying players whose true talent is masked by bad luck or defensive positioning. The <code>diff_rolling_OBA</code> metric compares rolling wOBA against expected wOBA over configurable plate-appearance windows to surface hidden value.</p>
    <div class="kpi-row" id="kpi-row"></div>
  </div>
</section>

<section class="section fade-section" id="rankings">
  <div class="section-header">
    <div class="section-tag">01 // Rankings</div>
    <h2 class="section-title">Underestimated Player Rankings</h2>
  </div>
  <div class="table-controls">
    <input type="text" id="search-input" placeholder="Search player or team...">
    <select id="pos-filter"><option value="">All Positions</option></select>
    <select id="team-filter"><option value="">All Teams</option></select>
    <div class="pa-toggle" id="pa-toggle">
      <button data-window="50">50 PA</button>
      <button data-window="100" class="active">100 PA</button>
      <button data-window="250">250 PA</button>
    </div>
  </div>
  <div class="table-wrap">
    <table id="player-table">
      <thead><tr>
        <th data-key="rank">#</th>
        <th data-key="name">Player</th>
        <th data-key="team">Team</th>
        <th data-key="pa">PA</th>
        <th data-key="wOBA">wOBA</th>
        <th data-key="xwOBA">xwOBA</th>
        <th data-key="diff_rolling_OBA">Diff (Rolling)</th>
        <th data-key="exit_velocity">EV</th>
        <th data-key="hard_hit_pct">HH%</th>
        <th data-key="barrel_pct">Brl%</th>
        <th data-key="batting_avg">AVG</th>
      </tr></thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>
  <div class="table-info" id="table-info"></div>
</section>

<section class="section fade-section" id="player-detail">
  <div class="section-header visible">
    <div class="section-tag">02 // Player Profile</div>
    <h2 class="section-title" id="detail-section-title">Player Detail</h2>
  </div>
  <div id="detail-placeholder" style="text-align:center;padding:60px 20px;color:var(--text-muted)">
    <div style="font-family:var(--font-display);font-size:1.3rem;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;color:var(--text-secondary)">Select a Player</div>
    <div style="font-size:.9rem;line-height:1.6">Click any row in the rankings table to view detailed player analytics, rolling trends, and Statcast metrics.</div>
  </div>
  <div id="single-detail" style="display:none">
    <div class="detail-grid">
      <div class="detail-card" id="detail-info"></div>
      <div class="detail-chart-wrap"><div id="detail-trend-chart" style="height:100%;min-height:340px"></div></div>
    </div>
  </div>
</section>

<section class="section fade-section" id="analytics">
  <div class="section-header">
    <div class="section-tag">03 // Analytics</div>
    <h2 class="section-title">League-Wide Distributions</h2>
  </div>
  <div class="charts-grid">
    <div class="chart-card chart-full">
      <div class="chart-card-title">xwOBA vs wOBA &mdash; Underestimation Map</div>
      <div class="chart-card-sub">Players below the diagonal are underperforming expected output based on contact quality</div>
      <div class="chart-container chart-container-tall" id="scatter-chart"></div>
    </div>
    <div class="chart-card">
      <div class="chart-card-title">diff_rolling_OBA Distribution</div>
      <div class="chart-card-sub">Frequency of rolling wOBA&ndash;xwOBA differentials</div>
      <div class="chart-container" id="hist-chart"></div>
    </div>
    <div class="chart-card">
      <div class="chart-card-title">Team Average Differential</div>
      <div class="chart-card-sub">Which rosters are collectively underestimated?</div>
      <div class="chart-container" id="team-chart"></div>
    </div>
  </div>
</section>

<section class="section fade-section" id="methodology">
  <div class="section-header">
    <div class="section-tag">04 // Methodology</div>
    <h2 class="section-title">How It Works</h2>
  </div>
  <div class="method-grid">
    <div class="method-card">
      <h3>wOBA</h3>
      <p>Weighted On-Base Average assigns linear weights to all offensive events &mdash; walks, singles, doubles, triples, home runs &mdash; based on their empirical run value. Unlike batting average, wOBA captures the true offensive contribution of each plate appearance.</p>
      <div class="formula">wOBA = (0.69*BB + 0.89*1B + 1.27*2B + 1.62*3B + 2.10*HR) / PA</div>
    </div>
    <div class="method-card">
      <h3>xwOBA</h3>
      <p>Expected wOBA uses Statcast data &mdash; exit velocity and launch angle &mdash; to predict what a player's wOBA <em>should</em> be based on quality of contact, removing the influence of luck, defensive alignment, and park effects.</p>
      <div class="formula">xwOBA = f(exit_velocity, launch_angle) per batted ball event</div>
    </div>
    <div class="method-card">
      <h3><code>diff_rolling_OBA</code></h3>
      <p>The core metric of this platform. Since xwOBA represents what a player's production <em>should</em> be based on contact quality, a large negative gap (wOBA &minus; xwOBA &lt; 0) means the player's actual results are significantly worse than expected. Historically, these gaps tend to regress &mdash; the larger the negative diff, the higher the probability that the player's wOBA will rebound toward xwOBA. This platform identifies exactly those players: batters whose current results are most likely to improve, making them the most underestimated.</p>
      <div class="formula">diff_rolling_OBA = rolling_wOBA(N PA) &minus; rolling_xwOBA(N PA)<br>Negative = underestimated &rarr; likely to rebound</div>
    </div>
  </div>
</section>

<footer class="footer">
  <p>MLB Underestimated Player Analyzer &middot; Powered by real <a href="https://baseballsavant.mlb.com" target="_blank">Baseball Savant</a> Statcast data.<br>
  wOBA linear weights from <a href="https://www.fangraphs.com" target="_blank">FanGraphs</a>. Rolling metrics computed from pitch-level event data.<br>
  Data auto-refreshes daily ~3 AM ET during the MLB season via GitHub Actions.</p>
  <p style="margin-top:12px;border-top:1px solid var(--border-subtle);padding-top:12px">
  Built by <strong style="color:var(--text-secondary)">Chung-Hao Lee</strong> &middot;
  <a href="https://lch99310.github.io/chunghao_lee/" target="_blank">Learn more about me / Contact</a></p>
</footer>

<script>
// ═══════════════════════════════════════════
// GLOBALS
// ═══════════════════════════════════════════
let PLAYERS = [];
let META = {};
let sortKey = 'diff_rolling_OBA';
let sortDir = 1;
let filtered = [];
let selectedPlayer = null;
let activeWindow = '100'; // current PA window
let detailWindow = '100'; // window shown in detail panel

function fmt(v, d) {
  if (v === null || v === undefined) return '\u2014';
  return Number(v).toFixed(d);
}

// ═══════════════════════════════════════════
// LOAD DATA
// ═══════════════════════════════════════════
async function loadData() {
  try {
    let data;
    if (window.PLAYER_DATA) {
      data = window.PLAYER_DATA;
    } else {
      const resp = await fetch('player_data.json');
      if (!resp.ok) throw new Error('player_data.json not found (HTTP ' + resp.status + ')');
      data = await resp.json();
    }
    META = { season: data.season, generated_at: data.generated_at, min_pa: data.min_pa, rolling_windows: data.rolling_windows };
    PLAYERS = data.players;
    init();
  } catch (e) {
    document.getElementById('loading').innerHTML = `
      <div style="text-align:center;color:var(--accent-red);font-family:var(--font-display);font-size:1.3rem;text-transform:uppercase">
        Error Loading Data
      </div>
      <div style="color:var(--text-secondary);margin-top:12px;font-size:.9rem;max-width:480px;text-align:center;line-height:1.6">
        Could not load player data. Run the pipeline first:<br><br>
        <code style="background:var(--bg-surface);padding:8px 16px;border-radius:4px;display:inline-block">pip install pybaseball &amp;&amp; python fetch_data.py &amp;&amp; python build.py</code><br><br>
        Error: ${e.message}
      </div>
    `;
  }
}

// Get diff for a player at the active window
function getDiff(p) {
  if (p.rolling && p.rolling[activeWindow] && p.rolling[activeWindow].diff_rolling_OBA !== null) {
    return p.rolling[activeWindow].diff_rolling_OBA;
  }
  return p.diff_rolling_OBA || 0;
}

// Get trend data for a player at a given window
function getTrend(p, win) {
  if (p.rolling && p.rolling[win]) {
    return {
      woba: p.rolling[win].trend_woba || [],
      xwoba: p.rolling[win].trend_xwoba || [],
      diff: p.rolling[win].trend_diff || []
    };
  }
  return { woba: [], xwoba: [], diff: [] };
}

function hasWindow(p, win) {
  return p.rolling && p.rolling[win] && p.rolling[win].diff_rolling_OBA !== null;
}

// ═══════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════
function init() {
  document.getElementById('loading').classList.add('hidden');
  setTimeout(() => document.getElementById('loading').style.display = 'none', 600);

  const eyebrow = document.getElementById('hero-eyebrow');
  eyebrow.childNodes[0].textContent = `Statcast-Powered Analytics // ${META.season} Season`;
  const genDate = new Date(META.generated_at);
  const heroDateStr = genDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  document.getElementById('hero-date').textContent = `Data: ${heroDateStr}`;

  renderKPIs();
  populateFilters();
  setupPAToggle();
  applyFilters();
  setupSort();
  setupSearch();
  setupScrollObservers();

  // Force rankings visible immediately (don't rely on scroll observer for first section)
  const rankSec = document.getElementById('rankings');
  rankSec.classList.add('visible');
  const rankHeader = rankSec.querySelector('.section-header');
  if (rankHeader) rankHeader.classList.add('visible');

  setTimeout(() => {
    initScatter();
    initHistogram();
    initTeamChart();
    // Auto-select the most underestimated player on load
    if (filtered.length > 0) {
      const most = [...PLAYERS].sort((a, b) => getDiff(a) - getDiff(b))[0];
      if (most) {
        selectedPlayer = most;
        showPlayerDetail(most, false); // false = don't scroll on initial load
        renderTable();
      }
    }
  }, 400);
}

// ═══════════════════════════════════════════
// KPIs
// ═══════════════════════════════════════════
function renderKPIs() {
  const sorted = [...PLAYERS].sort((a, b) => getDiff(a) - getDiff(b));
  const underest = PLAYERS.filter(p => getDiff(p) < 0);
  const avgDiff = PLAYERS.reduce((s, p) => s + getDiff(p), 0) / PLAYERS.length;
  const most = sorted[0];

  const genDate = new Date(META.generated_at);
  const dateStr = genDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

  document.getElementById('kpi-row').innerHTML = `
    <div class="kpi"><div class="kpi-label">Players Tracked</div><div class="kpi-value">${PLAYERS.length}</div><div class="kpi-detail">Updated ${dateStr}</div></div>
    <div class="kpi"><div class="kpi-label">Underestimated</div><div class="kpi-value" style="color:var(--accent-gold)">${underest.length}</div><div class="kpi-detail">${Math.round(underest.length / PLAYERS.length * 100)}% of tracked players</div></div>
    <div class="kpi"><div class="kpi-label">Avg Differential</div><div class="kpi-value" style="color:${avgDiff < 0 ? 'var(--negative-mid)' : 'var(--positive-mid)'}">${avgDiff > 0 ? '+' : ''}${avgDiff.toFixed(3)}</div><div class="kpi-detail">${activeWindow} PA rolling window</div></div>
    <div class="kpi"><div class="kpi-label">Most Underestimated</div><div class="kpi-value" style="font-size:1.2rem;color:var(--accent-red)">${most.name}</div><div class="kpi-detail">${getDiff(most) > 0 ? '+' : ''}${getDiff(most).toFixed(3)} diff &middot; ${most.team}</div></div>
  `;
}

// ═══════════════════════════════════════════
// PA WINDOW TOGGLE
// ═══════════════════════════════════════════
function setupPAToggle() {
  document.querySelectorAll('#pa-toggle button').forEach(btn => {
    btn.addEventListener('click', () => {
      activeWindow = btn.dataset.window;
      document.querySelectorAll('#pa-toggle button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      renderKPIs();
      applyFilters();
      initScatter();
      initHistogram();
      initTeamChart();
      // Also update player detail if one is selected
      if (selectedPlayer) {
        detailWindow = activeWindow;
        renderDetailCard(selectedPlayer);
        renderTrendChart(selectedPlayer, detailWindow);
      }
    });
  });
}

// ═══════════════════════════════════════════
// FILTERS
// ═══════════════════════════════════════════
function populateFilters() {
  const teams = [...new Set(PLAYERS.map(p => p.team).filter(Boolean))].sort();
  const teamSel = document.getElementById('team-filter');
  teams.forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = t; teamSel.appendChild(o); });
}

function setupSearch() {
  document.getElementById('search-input').addEventListener('input', applyFilters);
  document.getElementById('team-filter').addEventListener('change', applyFilters);
}

function applyFilters() {
  const q = document.getElementById('search-input').value.toLowerCase();
  const team = document.getElementById('team-filter').value;
  filtered = PLAYERS.filter(p => {
    if (q && !p.name.toLowerCase().includes(q) && !p.team.toLowerCase().includes(q)) return false;
    if (team && p.team !== team) return false;
    return true;
  });
  sortAndRender();
}

// ═══════════════════════════════════════════
// TABLE
// ═══════════════════════════════════════════
function diffColor(v) {
  if (v === null || v === undefined) return 'color:var(--text-muted)';
  if (v <= -0.040) return 'background:rgba(239,68,68,0.25);color:#fca5a5';
  if (v <= -0.020) return 'background:rgba(249,115,22,0.2);color:#fdba74';
  if (v < 0) return 'background:rgba(251,146,60,0.12);color:#fed7aa';
  if (v <= 0.020) return 'background:rgba(34,197,94,0.1);color:#86efac';
  if (v <= 0.040) return 'background:rgba(34,197,94,0.18);color:#4ade80';
  return 'background:rgba(34,197,94,0.25);color:#22c55e';
}

function sortAndRender() {
  filtered.sort((a, b) => {
    let va, vb;
    if (sortKey === 'diff_rolling_OBA') {
      va = getDiff(a); vb = getDiff(b);
    } else {
      va = a[sortKey]; vb = b[sortKey];
    }
    if (va === null || va === undefined) va = sortDir === 1 ? Infinity : -Infinity;
    if (vb === null || vb === undefined) vb = sortDir === 1 ? Infinity : -Infinity;
    if (typeof va === 'string') return sortDir * va.localeCompare(vb);
    return sortDir * (va - vb);
  });
  renderTable();
}

function renderTable() {
  const tbody = document.getElementById('table-body');
  tbody.innerHTML = filtered.map((p, i) => {
    const sel = selectedPlayer && selectedPlayer.player_id === p.player_id ? 'selected' : '';
    const diff = getDiff(p);
    const diffStr = diff !== null && diff !== undefined ? ((diff > 0 ? '+' : '') + diff.toFixed(3)) : '\u2014';
    return `<tr class="${sel}" data-pid="${p.player_id}">
      <td class="rank-cell">${i + 1}</td>
      <td class="player-name">${p.name}</td>
      <td class="team-cell">${p.team}</td>
      <td class="stat-cell">${p.pa}</td>
      <td class="stat-cell">${fmt(p.wOBA, 3)}</td>
      <td class="stat-cell">${fmt(p.xwOBA, 3)}</td>
      <td class="diff-cell" style="${diffColor(diff)}">${diffStr}</td>
      <td class="stat-cell">${fmt(p.exit_velocity, 1)}</td>
      <td class="stat-cell">${p.hard_hit_pct !== null && p.hard_hit_pct !== undefined ? fmt(p.hard_hit_pct, 1) + '%' : '\u2014'}</td>
      <td class="stat-cell">${p.barrel_pct !== null && p.barrel_pct !== undefined ? fmt(p.barrel_pct, 1) + '%' : '\u2014'}</td>
      <td class="stat-cell">${fmt(p.batting_avg, 3)}</td>
    </tr>`;
  }).join('');

  const withWindow = filtered.filter(p => hasWindow(p, activeWindow)).length;
  document.getElementById('table-info').textContent = `${filtered.length} players shown \xB7 ${withWindow} with ${activeWindow} PA rolling data \xB7 Sorted by ${sortKey} ${sortDir === 1 ? '\u25B2' : '\u25BC'}`;
}

function setupSort() {
  document.querySelectorAll('#player-table thead th').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.dataset.key;
      if (!key || key === 'rank') return;
      document.querySelectorAll('#player-table thead th').forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
      if (sortKey === key) sortDir *= -1;
      else { sortKey = key; sortDir = (key === 'diff_rolling_OBA') ? 1 : -1; }
      th.classList.add(sortDir === 1 ? 'sorted-asc' : 'sorted-desc');
      sortAndRender();
    });
  });
  document.querySelector('th[data-key="diff_rolling_OBA"]').classList.add('sorted-asc');

  // Row click
  document.getElementById('table-body').addEventListener('click', e => {
    const row = e.target.closest('tr');
    if (!row) return;
    const pid = parseInt(row.dataset.pid);
    const player = PLAYERS.find(p => p.player_id === pid);
    if (!player) return;

    selectedPlayer = player;
    showPlayerDetail(player, true);
    renderTable();
  });
}

// ═══════════════════════════════════════════
// PLAYER DETAIL
// ═══════════════════════════════════════════
function showPlayerDetail(p, shouldScroll) {
  detailWindow = activeWindow;
  const sec = document.getElementById('player-detail');
  sec.classList.add('active');
  document.getElementById('detail-placeholder').style.display = 'none';
  document.getElementById('single-detail').style.display = 'block';
  document.getElementById('detail-section-title').textContent = 'Player Detail';
  renderDetailCard(p);
  renderTrendChart(p, detailWindow);
  if (shouldScroll) {
    sec.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}

function renderDetailCard(p) {
  const diff = getDiffForWindow(p, detailWindow);
  const interp = diff < 0
    ? `Underperforming expectations by <strong>${Math.abs(diff).toFixed(3)}</strong> \u2014 likely underestimated`
    : `Outperforming expectations by <strong>${diff.toFixed(3)}</strong>`;
  const diffBg = diff < 0 ? 'background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2)' : 'background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2)';
  const diffCol = diff < 0 ? 'var(--negative-mid)' : 'var(--positive-mid)';

  // Show all windows; dim unavailable ones
  const windows = ['50', '100', '250'];
  const windowBtns = windows.map(w => {
    const has = hasWindow(p, w);
    let cls = w === detailWindow && has ? 'active' : '';
    if (!has) cls = 'disabled';
    return `<button class="${cls}" data-dw="${w}" data-available="${has}">${w} PA</button>`;
  }).join('');

  const savantUrl = `https://baseballsavant.mlb.com/savant-player/${p.player_id}`;

  document.getElementById('detail-info').innerHTML = `
    <div class="detail-name">${p.name}</div>
    <div class="detail-meta">
      <span class="team-badge">${p.team}</span>
      <span>${p.pa} PA</span>
      <span>AVG ${fmt(p.batting_avg, 3)}</span>
    </div>
    <a class="detail-savant-link" href="${savantUrl}" target="_blank">View on Baseball Savant &#x2197;</a>
    <div class="detail-window-toggle">${windowBtns}</div>
    <div class="woba-compare">
      <div class="woba-box"><div class="woba-box-label">wOBA (season)</div><div class="woba-box-value" style="color:var(--accent-blue)">${fmt(p.wOBA, 3)}</div></div>
      <div class="woba-box"><div class="woba-box-label">xwOBA (season)</div><div class="woba-box-value" style="color:var(--accent-gold)">${fmt(p.xwOBA, 3)}</div></div>
    </div>
    <div class="diff-display" style="${diffBg}">
      <div class="diff-display-value" style="color:${diffCol}">${diff > 0 ? '+' : ''}${diff.toFixed(3)}</div>
      <div class="diff-display-label">Rolling ${detailWindow} PA differential<br>${interp}</div>
    </div>
    <div class="statcast-grid">
      <div class="statcast-item"><div class="statcast-item-val">${fmt(p.exit_velocity, 1)}</div><div class="statcast-item-label">Exit Velo (mph)</div></div>
      <div class="statcast-item"><div class="statcast-item-val">${p.launch_angle !== null && p.launch_angle !== undefined ? fmt(p.launch_angle, 1) + '\u00B0' : '\u2014'}</div><div class="statcast-item-label">Launch Angle</div></div>
      <div class="statcast-item"><div class="statcast-item-val">${p.hard_hit_pct !== null && p.hard_hit_pct !== undefined ? fmt(p.hard_hit_pct, 1) + '%' : '\u2014'}</div><div class="statcast-item-label">Hard Hit %</div></div>
      <div class="statcast-item"><div class="statcast-item-val">${p.barrel_pct !== null && p.barrel_pct !== undefined ? fmt(p.barrel_pct, 1) + '%' : '\u2014'}</div><div class="statcast-item-label">Barrel %</div></div>
    </div>
    <div class="detail-actions">
      <button class="btn" onclick="closeDetail()">Close</button>
    </div>
  `;

  // Window toggle clicks in detail panel
  document.querySelectorAll('.detail-window-toggle button').forEach(btn => {
    btn.addEventListener('click', () => {
      if (btn.dataset.available === 'false') {
        alert(`This player does not have enough plate appearances for a ${btn.dataset.dw} PA rolling window.`);
        return;
      }
      detailWindow = btn.dataset.dw;
      renderDetailCard(p);
      renderTrendChart(p, detailWindow);
    });
  });
}

function getDiffForWindow(p, win) {
  if (p.rolling && p.rolling[win] && p.rolling[win].diff_rolling_OBA !== null) {
    return p.rolling[win].diff_rolling_OBA;
  }
  return p.diff_rolling_OBA || 0;
}

function closeDetail() {
  document.getElementById('player-detail').classList.remove('active');
  document.getElementById('detail-placeholder').style.display = 'block';
  document.getElementById('single-detail').style.display = 'none';
  selectedPlayer = null;
  renderTable();
}

let trendChart = null;
function renderTrendChart(p, win) {
  const el = document.getElementById('detail-trend-chart');
  if (trendChart) trendChart.dispose();
  trendChart = echarts.init(el, null, { renderer: 'svg' });

  const trend = getTrend(p, win);
  if (!trend.woba.length) {
    trendChart.setOption({
      backgroundColor: 'transparent',
      title: { text: `No ${win} PA rolling data available`, left: 'center', top: 'center', textStyle: { color: '#556a8a', fontSize: 14, fontFamily: 'Source Sans 3' } }
    });
    return;
  }

  const periods = trend.woba.map((_, i) => `${i + 1}`);

  // Compute diff trend from woba and xwoba if not provided
  const diffTrend = trend.diff.length === trend.woba.length
    ? trend.diff
    : trend.woba.map((w, i) => Math.round((w - trend.xwoba[i]) * 1000) / 1000);

  trendChart.setOption({
    backgroundColor: 'transparent',
    title: { text: `Rolling ${win} PA Trend`, left: 10, top: 4, textStyle: { color: '#8a9bb8', fontSize: 13, fontFamily: 'Oswald', fontWeight: 400 } },
    tooltip: {
      trigger: 'axis', backgroundColor: '#0f1f38', borderColor: '#1a2d4d',
      textStyle: { color: '#e8ecf2', fontFamily: 'Source Sans 3', fontSize: 12 },
      formatter: function(params) {
        let tip = `<strong>Period ${params[0].name}</strong><br>`;
        params.forEach(s => {
          tip += `<span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:${s.color};margin-right:4px"></span>${s.seriesName}: ${Number(s.value).toFixed(3)}<br>`;
        });
        return tip;
      }
    },
    legend: {
      data: ['wOBA', 'xwOBA', 'Diff (wOBA\u2212xwOBA)'],
      textStyle: { color: '#8a9bb8', fontFamily: 'Source Sans 3', fontSize: 11 },
      top: 4, right: 10
    },
    grid: { top: 44, right: 20, bottom: 30, left: 50 },
    xAxis: { type: 'category', data: periods, axisLine: { lineStyle: { color: '#1a2d4d' } }, axisLabel: { color: '#556a8a', fontSize: 10 } },
    yAxis: [
      {
        type: 'value',
        min: v => (v.min - 0.015).toFixed(3),
        max: v => (v.max + 0.015).toFixed(3),
        splitLine: { lineStyle: { color: 'rgba(255,255,255,0.04)' } },
        axisLabel: { color: '#556a8a', fontSize: 10, formatter: v => Number(v).toFixed(3) }
      },
      {
        type: 'value',
        splitLine: { show: false },
        axisLabel: { color: '#e8243c', fontSize: 10, formatter: v => (v > 0 ? '+' : '') + Number(v).toFixed(3) }
      }
    ],
    series: [
      {
        name: 'xwOBA', type: 'line', data: trend.xwoba, smooth: true, yAxisIndex: 0,
        lineStyle: { color: '#f0c040', width: 2 }, itemStyle: { color: '#f0c040' }, symbol: 'circle', symbolSize: 4,
        areaStyle: { color: 'rgba(240,192,64,0.06)' }
      },
      {
        name: 'wOBA', type: 'line', data: trend.woba, smooth: true, yAxisIndex: 0,
        lineStyle: { color: '#3b82f6', width: 2.5 }, itemStyle: { color: '#3b82f6' }, symbol: 'circle', symbolSize: 4,
        areaStyle: { color: 'rgba(59,130,246,0.06)' }
      },
      {
        name: 'Diff (wOBA\u2212xwOBA)', type: 'bar', data: diffTrend.map(d => ({
          value: d,
          itemStyle: {
            color: d < 0
              ? `rgba(239,68,68,${0.3 + Math.min(0.5, Math.abs(d) * 6)})`
              : `rgba(34,197,94,${0.3 + Math.min(0.5, d * 6)})`
          }
        })),
        yAxisIndex: 1, barWidth: '40%', z: 0
      }
    ]
  });
  window.addEventListener('resize', () => { if (trendChart) trendChart.resize(); });
}

// ═══════════════════════════════════════════
// ANALYTICS CHARTS
// ═══════════════════════════════════════════
let scatterChart, histChart, teamChart;

function initScatter() {
  const el = document.getElementById('scatter-chart');
  if (scatterChart) scatterChart.dispose();
  scatterChart = echarts.init(el, null, { renderer: 'svg' });

  const data = PLAYERS.map(p => ({
    value: [p.xwOBA, p.wOBA],
    name: p.name,
    diff: getDiff(p),
    team: p.team,
    pa: p.pa
  })).filter(d => d.value[0] != null && d.value[1] != null);

  const allVals = data.flatMap(d => d.value);
  const minV = Math.floor(Math.min(...allVals) * 100) / 100 - 0.01;
  const maxV = Math.ceil(Math.max(...allVals) * 100) / 100 + 0.01;

  scatterChart.setOption({
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'item', backgroundColor: '#0f1f38', borderColor: '#1a2d4d',
      textStyle: { color: '#e8ecf2', fontFamily: 'Source Sans 3', fontSize: 12 },
      formatter: p => `<strong>${p.data.name}</strong> (${p.data.team})<br>wOBA: ${p.data.value[1].toFixed(3)}<br>xwOBA: ${p.data.value[0].toFixed(3)}<br>Diff: ${p.data.diff > 0 ? '+' : ''}${p.data.diff.toFixed(3)}<br>PA: ${p.data.pa}`
    },
    grid: { top: 20, right: 30, bottom: 50, left: 60 },
    xAxis: {
      name: 'xwOBA (Expected)', nameLocation: 'center', nameGap: 32, nameTextStyle: { color: '#8a9bb8', fontFamily: 'Source Sans 3', fontSize: 12 },
      type: 'value', min: minV, max: maxV,
      splitLine: { lineStyle: { color: 'rgba(255,255,255,0.04)' } },
      axisLabel: { color: '#556a8a', fontSize: 10, formatter: v => v.toFixed(3) },
      axisLine: { lineStyle: { color: '#1a2d4d' } }
    },
    yAxis: {
      name: 'wOBA (Actual)', nameLocation: 'center', nameGap: 42, nameTextStyle: { color: '#8a9bb8', fontFamily: 'Source Sans 3', fontSize: 12 },
      type: 'value', min: minV, max: maxV,
      splitLine: { lineStyle: { color: 'rgba(255,255,255,0.04)' } },
      axisLabel: { color: '#556a8a', fontSize: 10, formatter: v => v.toFixed(3) },
      axisLine: { lineStyle: { color: '#1a2d4d' } }
    },
    series: [
      {
        type: 'line', data: [[minV, minV], [maxV, maxV]], symbol: 'none',
        lineStyle: { color: 'rgba(255,255,255,0.12)', width: 1, type: 'dashed' },
        z: 1, silent: true, tooltip: { show: false }
      },
      {
        type: 'scatter', data: data,
        symbolSize: (v, p) => Math.max(5, Math.min(16, Math.abs(p.data.diff) * 180)),
        itemStyle: {
          color: p => {
            const d = p.data.diff;
            if (d < -0.03) return 'rgba(239,68,68,0.85)';
            if (d < -0.01) return 'rgba(249,115,22,0.75)';
            if (d < 0.01) return 'rgba(148,163,184,0.5)';
            if (d < 0.03) return 'rgba(74,222,128,0.65)';
            return 'rgba(34,197,94,0.85)';
          },
          borderWidth: 0
        },
        z: 2
      }
    ],
    dataZoom: [{ type: 'inside', xAxisIndex: 0 }, { type: 'inside', yAxisIndex: 0 }]
  });
  window.addEventListener('resize', () => { if (scatterChart) scatterChart.resize(); });
}

function initHistogram() {
  const el = document.getElementById('hist-chart');
  if (histChart) histChart.dispose();
  histChart = echarts.init(el, null, { renderer: 'svg' });

  const diffs = PLAYERS.map(p => getDiff(p)).filter(d => d !== null && d !== undefined && isFinite(d));
  const step = 0.010;
  const minBin = Math.floor(Math.min(...diffs) / step) * step;
  const maxBin = Math.ceil(Math.max(...diffs) / step) * step;
  const bins = {};
  for (let b = minBin; b <= maxBin + step / 2; b = Math.round((b + step) * 1000) / 1000) {
    bins[b.toFixed(3)] = 0;
  }
  diffs.forEach(d => {
    let b = Math.floor(d / step) * step;
    b = Math.round(Math.max(minBin, Math.min(maxBin, b)) * 1000) / 1000;
    const key = b.toFixed(3);
    if (bins[key] !== undefined) bins[key]++;
  });
  const labels = Object.keys(bins);
  const vals = Object.values(bins);

  histChart.setOption({
    backgroundColor: 'transparent',
    tooltip: { trigger: 'axis', backgroundColor: '#0f1f38', borderColor: '#1a2d4d', textStyle: { color: '#e8ecf2', fontSize: 12 }, formatter: p => `Diff: ${p[0].name}<br>Players: ${p[0].value}` },
    grid: { top: 16, right: 16, bottom: 52, left: 44 },
    xAxis: {
      type: 'category', data: labels,
      axisLabel: { color: '#556a8a', fontSize: 9, rotate: 45, formatter: v => (parseFloat(v) > 0 ? '+' : '') + v },
      axisLine: { lineStyle: { color: '#1a2d4d' } }
    },
    yAxis: { type: 'value', splitLine: { lineStyle: { color: 'rgba(255,255,255,0.04)' } }, axisLabel: { color: '#556a8a', fontSize: 10 } },
    series: [{
      type: 'bar', data: vals.map((v, i) => ({
        value: v,
        itemStyle: { color: parseFloat(labels[i]) < 0 ? `rgba(239,68,68,${0.3 + Math.min(0.7, Math.abs(parseFloat(labels[i])) * 8)})` : `rgba(34,197,94,${0.3 + Math.min(0.7, parseFloat(labels[i]) * 8)})` }
      })),
      barWidth: '70%'
    }],
    dataZoom: [{ type: 'inside' }]
  });
  window.addEventListener('resize', () => { if (histChart) histChart.resize(); });
}

function initTeamChart() {
  const el = document.getElementById('team-chart');
  if (teamChart) teamChart.dispose();
  teamChart = echarts.init(el, null, { renderer: 'svg' });

  const teamMap = {};
  PLAYERS.forEach(p => {
    if (!p.team) return;
    if (!teamMap[p.team]) teamMap[p.team] = [];
    teamMap[p.team].push(getDiff(p));
  });
  const teamData = Object.entries(teamMap).map(([t, diffs]) => ({
    team: t, avg: Math.round(diffs.reduce((s, d) => s + d, 0) / diffs.length * 1000) / 1000, count: diffs.length
  })).sort((a, b) => a.avg - b.avg);

  teamChart.setOption({
    backgroundColor: 'transparent',
    tooltip: {
      trigger: 'axis', backgroundColor: '#0f1f38', borderColor: '#1a2d4d',
      textStyle: { color: '#e8ecf2', fontSize: 12 },
      formatter: p => `${p[0].name}<br>Avg Diff: ${p[0].value > 0 ? '+' : ''}${p[0].value.toFixed(3)}<br>Players: ${teamData.find(t => t.team === p[0].name)?.count || 0}`
    },
    grid: { top: 8, right: 16, bottom: 60, left: 44 },
    xAxis: {
      type: 'category', data: teamData.map(t => t.team),
      axisLabel: { color: '#8a9bb8', fontSize: 9, fontFamily: 'JetBrains Mono', rotate: 45, fontWeight: 600 },
      axisLine: { lineStyle: { color: '#1a2d4d' } }
    },
    yAxis: {
      type: 'value', splitLine: { lineStyle: { color: 'rgba(255,255,255,0.04)' } },
      axisLabel: { color: '#556a8a', fontSize: 10, formatter: v => (v > 0 ? '+' : '') + v.toFixed(3) }
    },
    series: [{
      type: 'bar', data: teamData.map(t => ({
        value: t.avg,
        itemStyle: { color: t.avg < 0 ? `rgba(239,68,68,${0.4 + Math.min(0.6, Math.abs(t.avg) * 12)})` : `rgba(34,197,94,${0.4 + Math.min(0.6, t.avg * 12)})` }
      })),
      barWidth: '60%'
    }],
    dataZoom: [{ type: 'inside' }]
  });
  window.addEventListener('resize', () => { if (teamChart) teamChart.resize(); });
}

// ═══════════════════════════════════════════
// SCROLL OBSERVERS
// ═══════════════════════════════════════════
function setupScrollObservers() {
  const observer = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        e.target.classList.add('visible');
        const h = e.target.querySelector('.section-header');
        if (h) h.classList.add('visible');
      }
    });
  }, { threshold: 0.1 });
  document.querySelectorAll('.fade-section').forEach(s => observer.observe(s));

  const navLinks = document.querySelectorAll('.topnav-links a');
  const navObserver = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        const id = e.target.id;
        navLinks.forEach(l => l.classList.remove('active'));
        const match = document.querySelector(`.topnav-links a[href="#${id}"]`);
        if (match) match.classList.add('active');
      }
    });
  }, { threshold: 0.3 });
  document.querySelectorAll('#rankings, #player-detail, #analytics, #methodology').forEach(s => navObserver.observe(s));
}

// ═══════════════════════════════════════════
// BOOT
// ═══════════════════════════════════════════
loadData();
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"75124c326cb447fe934cde04713ae013","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
